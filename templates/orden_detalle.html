{% extends "base.html" %}
{% block title %}Detalle Orden #{{ orden.numero }}{% endblock %}

{% block content %}

<h2>Orden de Servicio #{{ orden.numero }}</h2>

<a href="{{ url_for('ordenes.ordenes') }}"
   class="btn btn-secondary btn-sm mb-3">
    ← Volver a órdenes
</a>

<!-- ============================= -->
<!-- INFORMACIÓN PRINCIPAL -->
<!-- ============================= -->
<div class="card mb-3">
    <div class="card-header bg-dark text-white">
        Información de la orden
    </div>
    <div class="card-body">

        <p><strong>Cliente:</strong> {{ orden.cliente.nombre }}</p>

        <p><strong>Persona que reporta:</strong>
            {{ orden.persona_reporta }}
        </p>

        <hr>

        <p><strong>Descripción del problema:</strong></p>
        <p style="white-space: pre-wrap;">
            {{ orden.descripcion }}
        </p>

        {% if orden.solucion %}
            <hr>
            <p><strong>Resultado / Solución aplicada:</strong></p>
            <div class="alert alert-success"
                 style="white-space: pre-wrap;">
                {{ orden.solucion }}
            </div>
        {% else %}
            <hr>
            <p class="text-muted">
                <em>Aún no se ha registrado una solución.</em>
            </p>
        {% endif %}

        <hr>

        <p><strong>Creada por:</strong>
            {{ orden.usuario_creador.email if orden.usuario_creador else '—' }}
        </p>

        <p><strong>Fecha de creación:</strong>
            {{ orden.fecha_creacion.strftime('%Y-%m-%d %H:%M')
               if orden.fecha_creacion else '—' }}
        </p>

        <p><strong>Última edición:</strong>
            {{ orden.fecha_actualizacion.strftime('%Y-%m-%d %H:%M')
               if orden.fecha_actualizacion else '—' }}
        </p>

        <p><strong>Último editor:</strong>
            {{ orden.ultimo_editor.email if orden.ultimo_editor else '—' }}
        </p>

    </div>
</div>

<!-- ============================= -->
<!-- ARCHIVOS ADJUNTOS -->
<!-- ============================= -->
<div class="card mb-3">
    <div class="card-header">
        Archivos adjuntos
    </div>
    <div class="card-body">

        {% if orden.adjuntos %}
            <ul>
                {% for a in orden.adjuntos %}
                    <li>
                        <a href="{{ url_for('static',
                                   filename='uploads/' ~ a.archivo) }}"
                           target="_blank">
                            {{ a.archivo }}
                        </a>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">Sin archivos adjuntos.</p>
        {% endif %}

    </div>
</div>

<!-- ============================= -->
<!-- HISTORIAL DE CAMBIOS -->
<!-- ============================= -->
<div class="card mb-3">
    <div class="card-header">
        Historial de cambios
    </div>
    <div class="card-body">

        {% if orden.historial %}
            <ul>
                {% for h in orden.historial %}
                    <li>
                        <strong>{{ h.fecha.strftime('%Y-%m-%d %H:%M') }}</strong>
                        — {{ h.usuario.email }}
                        cambió <em>{{ h.campo }}</em>
                        de "{{ h.valor_anterior }}"
                        a "{{ h.valor_nuevo }}"
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted">Sin historial de cambios.</p>
        {% endif %}

    </div>
</div>

<!-- ============================= -->
<!-- ACCIONES -->
<!-- ============================= -->
<div class="mt-3">
    {% if current_user.rol in ['admin', 'tecnico'] %}
        <a href="{{ url_for('ordenes.editar_orden', orden_id=orden.id) }}"
           class="btn btn-primary">
            Editar orden
        </a>
    {% endif %}
</div>

{% endblock %}


