<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Orden #{{ orden.numero }}</title>
</head>
<body>

<!-- ================================================= -->
<!-- USUARIO / NAVEGACI√ìN -->
<!-- ================================================= -->
<p>
    Usuario: <strong>{{ current_user.email }}</strong> |
    Rol: <strong>{{ current_user.rol }}</strong> |
    <a href="{{ url_for('ordenes.ordenes') }}">‚¨Ö Volver</a> |
    <!-- BOT√ìN PDF -->
    <a href="{{ url_for('ordenes.descargar_pdf_orden', orden_id=orden.id) }}">
        üìÑ Descargar PDF
    </a>
</p>

<hr>

<!-- ================================================= -->
<!-- HISTORIAL DE CAMBIOS -->
<!-- ================================================= -->
<h3>Historial de cambios</h3>

{% if orden.historial %}
    <ul>
    {% for h in orden.historial %}
        <li>
            {{ h.fecha.strftime('%Y-%m-%d %H:%M') }} ‚Äî
            <strong>{{ h.usuario.email }}</strong>
            cambi√≥ <em>{{ h.campo }}</em><br>
            Antes: {{ h.valor_anterior }}<br>
            Despu√©s: {{ h.valor_nuevo }}
        </li>
    {% endfor %}
    </ul>
{% else %}
    <p>Sin cambios registrados.</p>
{% endif %}

<hr>

<!-- ================================================= -->
<!-- DATOS PRINCIPALES DE LA ORDEN -->
<!-- ================================================= -->
<h2>Orden de Servicio #{{ orden.numero }}</h2>

{% if current_user.rol == 'admin' %}
<p>
    <a href="{{ url_for('editar_orden', orden_id=orden.id) }}">
        ‚úèÔ∏è Editar orden
    </a>
</p>
{% endif %}

<ul>
    <li><strong>Cliente:</strong> {{ orden.cliente.nombre }}</li>
    <li><strong>Persona que reporta:</strong> {{ orden.persona_reporta }}</li>
    <li><strong>Observaciones:</strong> {{ orden.descripcion }}</li>
    <li><strong>Creado por:</strong> {{ orden.usuario_creador.email }}</li>
    <li>
        <strong>Fecha de creaci√≥n:</strong>
        {% if orden.fecha_creacion %}
            {{ orden.fecha_creacion.strftime('%Y-%m-%d %H:%M') }}
        {% else %}
            Sin fecha
        {% endif %}
    </li>
</ul>

<hr>

<!-- ================================================= -->
<!-- ARCHIVOS ADJUNTOS -->
<!-- ================================================= -->
<h3>Archivos adjuntos</h3>

{% if orden.adjuntos %}
<ul>
    {% for a in orden.adjuntos %}
        <li>
            <a href="{{ url_for('static', filename='uploads/' ~ a.archivo) }}" target="_blank">
                {{ a.archivo }}
            </a>

            {% if current_user.rol == 'admin' %}
                | <a href="{{ url_for('adjuntos.eliminar_adjunto', adjunto_id=a.id) }}"
                     onclick="return confirm('¬øEliminar archivo?')">Eliminar</a>
            {% endif %}
        </li>
    {% endfor %}
</ul>
{% else %}
<p>Sin archivos adjuntos</p>
{% endif %}

<hr>

<!-- ================================================= -->
<!-- AUDITOR√çA -->
<!-- ================================================= -->
<h4>Auditor√≠a</h4>

<p>
    Creada el:
    {% if orden.fecha_creacion %}
        {{ orden.fecha_creacion.strftime('%Y-%m-%d %H:%M') }}
    {% else %}
        Sin fecha
    {% endif %}
</p>

{% if orden.fecha_actualizacion %}
<p>
    √öltima edici√≥n:
    {{ orden.fecha_actualizacion.strftime('%Y-%m-%d %H:%M') }}
</p>
{% endif %}

</body>
</html>

