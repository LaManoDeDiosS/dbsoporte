{% extends "base.html" %}
{% block title %}Órdenes de Servicio{% endblock %}
{% block content %}

{% if current_user.rol == 'admin' %}
<hr>

<h3>Registrar nueva orden</h3>

<form method="POST" enctype="multipart/form-data" class="mb-4">
    {{ form.hidden_tag() }}

    <div class="mb-3">
        {{ form.cliente.label(class="form-label") }}
        {{ form.cliente(class="form-select") }}
    </div>

    <div class="mb-3">
        {{ form.persona.label(class="form-label") }}
        {{ form.persona(class="form-control") }}
    </div>

    <div class="mb-3">
        {{ form.descripcion.label(class="form-label") }}
        {{ form.descripcion(class="form-control", rows=4) }}
    </div>

    <div class="mb-3">
        {{ form.archivos.label(class="form-label") }}
        {{ form.archivos(class="form-control", multiple=True) }}
    </div>

    <button class="btn btn-success">
        Crear orden
    </button>
</form>
{% endif %}

<p>
    Usuario: <strong>{{ current_user.email }}</strong> |
    Rol: <strong>{{ current_user.rol }}</strong>
</p>

<hr>

<h3>Buscar orden</h3>

<form method="GET" action="{{ url_for('ordenes.ordenes') }}" class="row g-2 mb-4">

    <div class="col-md-3">
        <input type="number"
               name="numero"
               class="form-control"
               placeholder="Número de orden"
               value="{{ numero_busqueda or '' }}">
    </div>

    <div class="col-md-4">
        <input type="text"
               name="texto"
               class="form-control"
               placeholder="Persona o descripción"
               value="{{ texto_busqueda or '' }}">
    </div>

    <div class="col-md-3">
        <select name="cliente_id" class="form-select">
            <option value="">Todos los clientes</option>
            {% for c in clientes %}
                <option value="{{ c.id }}"
                    {% if cliente_busqueda == c.id %}selected{% endif %}>
                    {{ c.nombre }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div class="col-md-2 d-grid">
        <button class="btn btn-primary">Buscar</button>
    </div>

</form>

<h3>Listado de órdenes</h3>

<div class="table-responsive">
<table class="table table-striped table-hover align-middle table-fixed">

    <thead class="table-dark">
        <tr>
            <th>#</th>
            <th>Cliente</th>
            <th>Reporta</th>
            <th>Observación</th>
            <th>Creado por</th>
            <th>Creación</th>
            <th>Edición</th>
            <th>Estado</th>
            <th>Archivos</th>
            <th>Editor</th>
            <th>Acciones</th>
        </tr>
    </thead>

    <tbody>
    {% for o in ordenes %}
        <tr>

            <td>
                <a href="{{ url_for('ordenes.editar_orden', orden_id=o.id) }}">
                    {{ o.numero }}
                </a>
            </td>

            <td>{{ o.cliente.nombre }}</td>

            <td>{{ o.persona_reporta }}</td>

            <td class="col-obs">
                {{ o.descripcion[:80] }}
                {% if o.descripcion|length > 80 %}…{% endif %}
            </td>

            <td>{{ o.usuario_creador.email if o.usuario_creador else '—' }}</td>

            <td>
                {{ o.fecha_creacion.strftime('%Y-%m-%d %H:%M')
                   if o.fecha_creacion else '—' }}
            </td>

            <td>
                {{ o.fecha_actualizacion.strftime('%Y-%m-%d %H:%M')
                   if o.fecha_actualizacion else '—' }}
            </td>

            <td>
                {% if o.estado == 'abierta' %}
                    <span class="badge bg-warning text-dark">Abierta</span>
                {% elif o.estado == 'en_proceso' %}
                    <span class="badge bg-primary">En proceso</span>
                {% if o.estado != 'cerrada' %}
    <a href="{{ url_for('ordenes.editar_orden', orden_id=o.id) }}"
       class="btn btn-sm btn-primary">
        Editar
    </a>
{% else %}
    <span class="text-muted">Cerrada</span>
{% endif %}
                {% endif %}
            </td>

            <td class="col-files">
                {% if o.adjuntos %}
                    {% for a in o.adjuntos %}
                        <a href="{{ url_for('static', filename='uploads/' ~ a.archivo) }}"
                           class="btn btn-sm btn-outline-secondary mb-1"
                           target="_blank">
                            Ver archivo
                        </a><br>
                    {% endfor %}
                {% else %}
                    —
                {% endif %}
            </td>

            <td>
                {{ o.ultimo_editor.email if o.ultimo_editor else '—' }}
            </td>

            <td class="text-center">
                <a href="{{ url_for('ordenes.editar_orden', orden_id=o.id) }}"
                   class="btn btn-sm btn-primary">
                    Editar
                </a>

                {% if current_user.rol == 'admin' %}
                <form method="POST"
                      action="{{ url_for('ordenes.eliminar_orden', orden_id=o.id) }}"
                      style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-sm btn-danger"
                            onclick="return confirm('¿Eliminar orden?')">
                        Eliminar
                    </button>
                </form>
                {% endif %}
            </td>

        </tr>
    {% endfor %}
    </tbody>

</table>
</div>

{% endblock %}
