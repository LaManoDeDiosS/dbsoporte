<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Órdenes de Servicio</title>
</head>
<body>

<h2>Órdenes de Servicio</h2>

<p>
    Usuario: <strong>{{ current_user.email }}</strong>
    |
    Rol: <strong>{{ current_user.rol }}</strong>
    |
    <a href="{{ url_for('auth.login') }}">Cerrar sesión</a>
</p>

<hr>

{% if current_user.rol == 'admin' %}
<h3>Registrar nueva orden</h3>

<form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}

    <p>{{ form.cliente.label }}<br>{{ form.cliente() }}</p>
    <p>{{ form.persona.label }}<br>{{ form.persona() }}</p>
    <p>{{ form.descripcion.label }}<br>{{ form.descripcion(rows=4) }}</p>
    <p>{{ form.archivos.label }}<br>{{ form.archivos(multiple=True) }}</p>

    <p>{{ form.submit(value='Guardar orden') }}</p>
</form>

<hr>
{% endif %}

<h3>Buscar orden</h3>

<form method="GET" action="{{ url_for('buscar') }}">
    <input type="number" name="numero" placeholder="Número de orden" required>
    <button type="submit">Buscar</button>
</form>

<h3>Listado de órdenes</h3>

<table border="1" cellpadding="6" cellspacing="0">
    <tr>
        <th>Número</th>
        <th>Cliente</th>
        <th>Persona que reporta</th>
        <th>Observación</th>
        <th>Creado por</th>
        <th>Fecha creación</th>
        <th>Última edición</th>
        <th>Archivos</th>
        <th>Última edición por</th>
        <th>Acciones</th>
    </tr>

    {% for o in ordenes %}
    <tr>
        <td>
            <a href="{{ url_for('detalle_orden', orden_id=o.id) }}">
                {{ o.numero }}
            </a>
        </td>

        <td>{{ o.cliente.nombre }}</td>
        <td>{{ o.persona_reporta }}</td>
        <td>{{ o.descripcion }}</td>

        <td>
            {{ o.usuario_creador.email if o.usuario_creador else 'Desconocido' }}
        </td>

        <td>
            {{ o.fecha_creacion.strftime('%Y-%m-%d %H:%M') if o.fecha_creacion else '—' }}
        </td>

        <td>
            {{ o.fecha_actualizacion.strftime('%Y-%m-%d %H:%M') if o.fecha_actualizacion else '—' }}
        </td>

        <td>
            {% if o.adjuntos %}
                <ul>
                    {% for a in o.adjuntos %}
                    <li>
                        <a href="{{ url_for('static', filename='uploads/' ~ a.archivo) }}" target="_blank">
                            {{ a.archivo }}
                        </a>

                        {% if current_user.rol == 'admin' %}
                            | <a href="{{ url_for('adjuntos.eliminar_adjunto', adjunto_id=a.id) }}"
                                 onclick="return confirm('¿Eliminar archivo?')">
                                Eliminar
                              </a>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                Sin archivos
            {% endif %}
        </td>

        <td>
            {{ o.ultimo_editor.email if o.ultimo_editor else '—' }}
        </td>

        <!-- ACCIONES -->
        <td>
            <div style="display:flex; gap:6px; align-items:center;">

                {% if current_user.rol in ['admin', 'tecnico'] %}
                    <a href="{{ url_for('ordenes.editar_orden', orden_id=o.id) }}">
                        Editar
                    </a>
                {% endif %}

                {% if current_user.rol == 'admin' %}
                    <form action="{{ url_for('ordenes.eliminar_orden', orden_id=o.id) }}"
                          method="POST"
                          style="margin:0;">

                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <button type="submit"
                                onclick="return confirm('¿Eliminar esta orden?')">
                            Eliminar
                        </button>
                    </form>
                {% endif %}

                {% if current_user.rol not in ['admin', 'tecnico'] %}
                    —
                {% endif %}

            </div>
        </td>
    </tr>
    {% endfor %}
</table>

</body>
</html>
