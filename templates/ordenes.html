<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Órdenes de Servicio</title>
</head>
<body>

<h2>Órdenes de Servicio</h2>

<p>
    Usuario: <strong>{{ current_user.email }}</strong>
    | Rol: <strong>{{ current_user.rol }}</strong>
    | <a href="{{ url_for('auth.login') }}">Cerrar sesión</a>
</p>

<hr>

{% if current_user.rol == 'admin' %}
<h3>Registrar nueva orden</h3>

<form method="POST" enctype="multipart/form-data">
    {{ form.hidden_tag() }}

    <p>
        {{ form.cliente.label }}<br>
        {{ form.cliente() }}
    </p>

    <p>
        {{ form.persona.label }}<br>
        {{ form.persona() }}
    </p>

    <p>
        {{ form.descripcion.label }}<br>
        {{ form.descripcion(rows=4) }}
    </p>

    <p>
        {{ form.archivos.label }}<br>
        {{ form.archivos(multiple=True) }}
    </p>

    <p>
        {{ form.submit() }}
    </p>
</form>

<hr>
{% endif %}

<h3>Listado de órdenes</h3>

<table border="1" cellpadding="6" cellspacing="0">
    <tr>
        <th>Número</th>
        <th>Cliente</th>
        <th>Persona que reporta</th>
        <th>Observación</th>
        <th>Creado por</th>
        <th>Fecha</th>
        <th>Archivos</th>
    </tr>

    {% for o in ordenes %}
    <tr>
        <td>{{ o.numero }}</td>
        <td>{{ o.cliente.nombre }}</td>
        <td>{{ o.persona_reporta }}</td>
        <td>{{ o.descripcion }}</td>

        <td>
            {% if o.usuario %}
                {{ o.usuario.email }}
            {% else %}
                Desconocido
            {% endif %}
        </td>

        <td>
            {% if o.fecha %}
                {{ o.fecha.strftime('%Y-%m-%d %H:%M') }}
            {% else %}
                Sin fecha
            {% endif %}
        </td>

        <td>
            {% if o.adjuntos %}
                <ul>
                {% for a in o.adjuntos %}
                    <li>
                        <a href="{{ url_for('static', filename='uploads/' ~ a.archivo) }}" target="_blank">
                            {{ a.archivo }}
                        </a>

                        {% if current_user.rol == 'admin' %}
                            | <a href="{{ url_for('adjuntos.eliminar_adjunto', adjunto_id=a.id) }}"
                                 onclick="return confirm('¿Eliminar archivo?')">
                                 Eliminar
                              </a>
                        {% endif %}
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                Sin archivos
            {% endif %}
        </td>
    </tr>
    {% endfor %}
</table>

</body>
</html>
